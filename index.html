<!DOCTYPE html>
<html>
<head>

    <meta charset="utf-8">
    <meta name="viewport" content="initial-scale=1, maximum-scale=1,user-scalable=no">

    <title>Call Explorer</title>

    <link rel="apple-touch-icon" sizes="120x120" href="icons/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="icons/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="icons/favicon-16x16.png">
    <link rel="manifest" href="icons/site.webmanifest">
    <link rel="mask-icon" href="icons/safari-pinned-tab.svg" color="#5bbad5">
    <link rel="shortcut icon" href="icons/favicon.ico">
    <meta name="msapplication-TileColor" content="#2b5797">
    <meta name="msapplication-config" content="icons/browserconfig.xml">
    <meta name="theme-color" content="#ffffff">

    <!-- Materialize -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css">
    <link href="https://fonts.googleapis.com/css?family=Roboto" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css?family=Product+Sans:400,400i,700,700i" rel="stylesheet" type="text/css">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css?family=Product+Sans:400,400i,700,700i" rel="stylesheet" type="text/css">

    <!--Animate Css-->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.7.0/animate.min.css"> <!--https://daneden.github.io/animate.css/-->

    <style>
        [v-cloak] { display: none; } 
        html { height:100%; overflow:hidden; }
        select[multiple]{height:100px !important; font-size:0.9em;}
        input[type=checkbox] + span { color: black; }

        .fromTo { width:70px !important; padding-top:5px; padding-bottom:5px; }   
        .fromToDate{ width:90px !important; }        
        .marginLeft { margin-left: 20px !important; }
        .marginLeftParamsHidden { margin-left: -4em !important; }
        .clearParameterButton { font-size: 0.7em; }
        .parameter-label2 { font-size: 0.9em !important; }
        .parameter-multiselect-selected { font-size: 0.7em !important; }
        .hl{ background:#007bff; color:white; }
        
        .results-box { height: 770px; }
        .results-box-layout { height: 60px; }
        .results-box-options { height: 50px; }
        .results-box-thead { height: 105px; }
        .results-box-tbody { height: calc(770px - 60px - 50px - 105px - 80px); }
        .results-table { border-top:solid 1px whitesmoke; } 
        .results-table td { border-left:solid 1px whitesmoke; border-right:solid 1px whitesmoke; }
        .results-table-colGroup-start { border-left: solid 1px gainsboro; }
        .results-table-colGroup-end { border-right: solid 1px gainsboro; }

        .call-count-animation { animation-iteration-count: 5 !important; }
    </style>
   
    <style>
        #viewDiv { padding: 0; height: 700px; width: 100%; margin-top: 0; margin-bottom: 0; margin-left: auto; margin-right: auto; padding-left: 1em; padding-right: 1em; }
    </style>
    
    <!--Settings.json-->
    <script src="settings.js"></script>

    <!--JQuery-->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.js"></script>

    <!--DateJS-->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/datejs/1.0/date.min.js"></script>

    <!--VueJS-->
    <script src="https://unpkg.com/vue/dist/vue.js"></script>
    
    <!-- axios -->
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>

    <!-- materialize -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>

    <!--ArcGIS-->
    <link rel="stylesheet" href="https://js.arcgis.com/4.10/esri/css/main.css">   
    <script src="https://js.arcgis.com/4.10/"></script>
</head>

<body>

    <div id="app" v-cloak class="grey lighten-4">
        
        <!--..........................-->
        <!--Navbar -->
        <!--..........................-->
        <div class="navbar">
            <nav>
                <div class="nav-wrapper grey darken-4 white-text">
                    <a class="brand-logo">&nbsp Calls Explorer <small style="color:yellow;">(BETA)</small></a>           
                    <ul id="nav-mobile" class="right hide-on-med-and-down">
                        <!--Matches Found-->
                        <li class="animated infinite rubberBand" v-bind:class="{'call-count-animation': calls.length > 0}">
                            <a>
                                <span>
                                    <b v-if="calls.length > 0">Matches found: {{calls.length}}</b>
                                    <b v-if="calls.length > 0 && oppositeCalls.length > 0">
                                        vs {{oppositeCalls.length}} 
                                        <small>(Opposite Parameter)</small>
                                        <small>( {{ oppositeCallsPercent }} = {{calls.length}} / ({{calls.length}}+{{oppositeCalls.length}}) )</small> 
                                        <br> 
                                        <small>{{oppositeCallsWhereExplanation}}</small>
                                    </b>
                                </span>
                            </a>
                        </li>
                        <li>
                            <a class="modal-trigger tooltipped" data-position="bottom" data-tooltip="Get a url with this query parameters" href="#modal1">
                                <i class="material-icons">link</i>
                            </a>
                        </li>                        
                    </ul>     
                </div>
            </nav>
        </div> 

        <!--..........................-->
        <!--Main Body -->
        <!--..........................-->
        <div class="row main-body">

            <!--..........................-->
            <!--Parameters -->
            <!--..........................-->

            <!--Parameters hidden side column-->
            <div class="col m1" v-show="showParams==false" style="padding:0;">
                
                <div class="grey darken-4 center-align" style="width:50px; height:100vh;">
                    
                    <i 
                        class="material-icons white-text tooltipped" 
                        data-position="bottom" data-tooltip="Show the parameter panel"
                        style="top:0;margin-top:25px; cursor:pointer;" 
                        v-on:click="showParams=!showParams"
                        >chevron_right
                    </i>  

                    <span class="grey-text" style="writing-mode: vertical-rl; text-orientation: upright; font-size:1.5em;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;PARAMETERS</span>                  
                </div>

            </div>

            <div class="col m4 parameters-column grey lighten-4" style="border-right:solid 1px lightgray">

                <!--Title / Controls-->
                <div class="row">
                    <div class="col m12">
                        <h5 class="left" style="margin-top:20px;">Parameters</h5>
                        <i 
                            class="material-icons right tooltipped" 
                            style="margin-top:25px;cursor:pointer;" 
                            v-on:click="showParams=!showParams" 
                            data-position="left" data-tooltip="Minimize the parameter panel"
                            >chevron_left
                        </i>
                    </div>
                    <div class="col m12">
                        <br>
                        <a 
                            class="waves-effect waves-light btn red tooltipped" 
                            v-on:click="runReport() ; showParams = false"
                            data-position="bottom" data-tooltip="After entering your parameters, click here to run the report">
                            <i class="material-icons left">bubble_chart</i>
                            Run Report
                        </a>
                        <a 
                            class="waves-effect waves-teal btn-flat right tooltipped" 
                            v-on:click="resetAllParameters()"
                            data-position="left" data-tooltip="Reset all parameters"
                            >Reset
                        </a>  
                        <br><br>
                    </div>   
                </div>

                <!--Parameters Container-->
                <div class="row">
                    <div class="col m12 parameters-accordion-container " style="height:calc(100vh - 180px); overflow-y:scroll; overflow-x:hidden;">

                        <!--Accordion-->
                        <ul class="collapsible">
                            <li v-for="section in paramSections">

                                <!--Section title-->
                                <div class="collapsible-header" 
                                        v-bind:class="{'grey darken-4 white-text':activeSection == section.title1}" 
                                        v-on:click="activeSection=section.title1">
                                    <i class="material-icons">all_inclusive</i>
                                    {{section.title1}}
                                    <span v-if="countActive(section.name)>0" class="new badge grey darken-2" data-badge-caption="">{{countActive(section.name)}}</span>
                                </div>
                                
                                <!--Section Body-->
                                <div class="collapsible-body" v-bind:class="{'grey lighten-4': activeSection == section.title1}">
                                    
                                    <div class="row">
                                        <b>{{section.title2}}</b>
                                    </div>

                                    <!--Parameters in this section-->
                                    <div class="row" v-for="param in parametersArrayFiltered(section.name)">

                                        <!--Parameter Title-->
                                        <div class="col m5">

                                            <!--Label 1-->
                                            <span>{{param.settings.label1}}</span>  

                                            <!--Label2-->
                                            <div v-if="param.settings.type != 'boolean'">
                                                <small><i>{{param.settings.label2}}</i></small>
                                            </div>

                                            <!--Special map layer for this parameter?-->
                                            <div v-if="param.settings.hasOwnProperty('mapService')">
                                                <small>*Map will include a special layer</small>
                                            </div>

                                            <!--Include Opposite Parameter ?-->
                                            <div v-if="param.settings.hasOwnProperty('oppositeParameter')">
                                                <div>
                                                    <div class="custom-control custom-checkbox">
                                                        <input 
                                                            type="checkbox" 
                                                            class="custom-control-input" 
                                                            v-bind:id="'customCheckOpposite'+param.name" 
                                                            v-model="parameters[param.name].oppositeParameter.include"
                                                            v-bind:disabled="(parameters[param.name].hasOwnProperty('selected') ? parameters[param.name].selected.length == 0 : parameters[param.name].value.length == 0)"
                                                            >
                                                        <label 
                                                            class="custom-control-label" 
                                                            style="color:gainsboro;font-size:0.7em;padding-top:3px;" 
                                                            v-bind:for="'customCheckOpposite'+param.name"
                                                            >Include Count of Opposite Results?
                                                        </label>
                                                    </div>
                                                </div>
                                            </div>
                                        </div> <!--col m4-->

                                        <!--Parameter Form-Control-->
                                        <div class="col m7">

                                            <!--````````````````````````````````````-->
                                            <!--CSV-->
                                            <!--````````````````````````````````````-->
                                            <div v-if="param.settings.type == 'csv'">
                                                <input type="text" class="singleValue" v-model="parameters[param.name].value"/>
                                                <a class="btn-flat btn-small clearParameterButton" v-on:click="resetCsv(param.name)">Clear</a>
                                            </div>

                                            <!--````````````````````````````````````-->
                                            <!--Text-->
                                            <!--````````````````````````````````````-->
                                            <div v-if="param.settings.type == 'text'">
                                                <input type="text" class="singleValue" v-model="parameters[param.name].value"/>
                                                <a class="btn-flat btn-small clearParameterButton" v-on:click="parameters[param.name].value=[]">Clear</a>
                                            </div>
                                            
                                            <!--````````````````````````````````````-->
                                            <!--MultiSelect-->
                                            <!--````````````````````````````````````-->
                                            <div v-if="param.settings.type == 'multiselect'" class="input-field ">
                                                <select v-model="parameters[param.name].value" multiple class="materialSelect" v-bind:id="'ms_'+param.name">
                                                    <option disabled value="">Choose an Option</option>
                                                    <!--<option v-for="option in parameters[param.name].options" v-bind:value="option.code">{{option.code + (option.description.length > 0 ? " | " + option.description : "")}}</option>-->
                                                </select>
                                                <a class="btn-flat btn-small clearParameterButton" v-on:click="resetMultipleChoice(param.name)">Clear</a>
                                                <div class="parameter-multiselect-selected" v-if="parameters[param.name].value.length > 0">{{parameters[param.name].value}}</div>
                                            </div>
                                                    
                                            <!--````````````````````````````````````-->
                                            <!--From-To-->
                                            <!--````````````````````````````````````-->
                                            <div v-if="param.settings.loHi == true">
                                                <input v-bind:type="(param.settings.type == 'integer' ? 'number' : 'text')" class="fromTo text-center" v-model="parameters[param.name.replace(right(param.name,2),'Lo')].value"/>
                                                to
                                                <input v-bind:type="(param.settings.type == 'integer' ? 'number' : 'text')" class="fromTo text-center" v-model="parameters[param.name.replace(right(param.name,2),'Hi')].value"/>
                                                <a class="btn-flat btn-small clearParameterButton" v-on:click="resetFromTo(param.name.replace(right(param.name,2),'Lo'),param.name.replace(right(param.name,2),'Hi'))">Clear</a>                                              
                                            </div>

                                            <!--````````````````````````````````````-->
                                            <!--Boolean-->
                                            <!--````````````````````````````````````-->
                                            <div v-if="param.settings.type == 'boolean'">
                                                <label>
                                                    <input 
                                                        type="checkbox" 
                                                        v-bind:id="'customCheck'+param.name" 
                                                        v-model="parameters[param.name].value"
                                                        v-on:change="(param.name.substr(0,15)=='AC_DateReceived' ? resetDateParams(param.name,parameters[param.name].value) : '')"                                                            
                                                        >
                                                    <span v-bind:for="'customCheck'+param.name" class="parameter-label2">{{param.settings.label2}}</span>
                                                </label>
                                            </div> 
                                        
                                        </div> <!--end col m8-->

                                    </div> <!--end row-->

                                </div> <!--end collapsible body-->

                            </li> <!--end section-->

                        </ul> <!--end collapsible-->
                        <br>
                        <br>
                
                    </div> <!--end col-->
                </div> <!--end row-->
            </div> <!--end parameters column m3-->
        
            <!--................................-->
            <!-- Results Column -->
            <!--................................-->
            <div class="results-column grey lighten-4" v-bind:class="{'col m11':showParams==false,'col m8':showParams==true, 'marginLeftParamsHidden': showParams==false}">

                <!-- main content -->
                <div class="row main-content-row" v-bind:class="{'marginLeft':showParams==true}" style="margin-right: 1em;">
                    
                    <div class="col m12 main-content-col">

                        <!--Your Query-->
                        <div class="row blue darken-1 white-text" v-if="paramsPretty.length > 1" style="margin-top:1em; padding:1em;">
                            <div class="col m12">
                                <b>Your Query:</b>
                                <br>
                                <span style="font-family: 'Courier New', Courier, monospace" v-if="paramsPretty.length > 0">{{paramsPretty}}</span>
                                <span style="font-family: 'Courier New', Courier, monospace" v-if="paramsPretty.length== 0">Select your parameters</span>
                            </div>
                        </div>

                        <!--Hero center / Examples-->
                        <div class="row" v-if="calls.length == 0 && noResultsFound == false && ajaxInProgress==false" style="margin-top:2em;">
                            <section class="card-panel grey lighten-2" style="padding-bottom:150px; box-shadow: 0px 0px 0px 0px rgba(0,0,0,0)">
                                <div class="container center-align">
                                    <h1>Call Explorer</h1>
                                    <p class="lead text-muted">Use the panel on the left to query the CAD system about calls. Begin with the thought: "How many calls have we had where X happened?"</p>
                                    <p>
                                    <a class="waves-effect waves-light btn grey darken-4" v-on:click="example1()">Ex: False Alarms in the Past Month</a>
                                    <a class="waves-effect waves-light btn grey darken-4" v-on:click="example2()">Ex: Priority 1 Calls Holding > 5 Minutes</a>
                                    </p>
                                    <h4>{{exampleMessage}}</h4>
                                </div>
                            </section>
                        </div>

                        <!--Messages-->
                        <div class="row messages-row" v-if="serverErrorOccurred == true || noResultsFound == true">
                            <div class="col m12">  
                                <center v-if="serverErrorOccurred == true" class="text-primary">
                                    <br><br><hr><br><br>
                                    <h4>An error occurred on the server</h4>
                                    <br><br><hr>
                                </center>
        
                                <center v-if="noResultsFound == true" class="text-primary">
                                    <br><br><hr><br><br>
                                    <h4>No records matched this query</h4>
                                    <br><br><hr>
                                </center>     
                            </div>  
                        </div>

                        <!--Loading-->
                        <div class="row" v-if="ajaxInProgress == true">
                            <div class="col m12 center-align">
                                <h4>Loading...</h4>
                            </div>
                        </div>

                        <!--Results Container-->
                        <div class="row white" v-show="resultsMode == 'table' && calls.length > 0">  

                            <div class="col m12 results-box" style="border:solid 1px gray;">

                                <!--Table or Map Buttons-->
                                <div class="row results-box-layout" v-if="calls.length > 1">
                                    <div class="col m12 center-align">
                                        <a  class="waves-effect waves-light btn-flat tooltipped" 
                                            data-position="bottom" data-tooltip="View results in table-format"
                                            v-on:click="resultsMode = 'table'" 
                                            v-bind:class="{'blue-text':resultsMode == 'table'}">
                                            <i class="material-icons left">menu</i>
                                            Table
                                        </a>
                                        <a  class="waves-effect waves-light btn-flat tooltipped" 
                                            data-position="bottom" data-tooltip="View results on a map"
                                            v-on:click="resultsMode = 'map'" 
                                            v-bind:class="{'blue-text':resultsMode == 'map'}">
                                            <i class="material-icons left">location_on</i>
                                            Map
                                        </a>                             
                                    </div>                                    
                                </div>

                                <div class="row results-box-options" style="padding:1em;" v-if="calls.length > 0 || noResultsFound == true"> 
                                    
                                    <!--Server's query?-->
                                    <div class="col m2">
                                        <label>
                                            <input type="checkbox" v-model="showServerWhereClause" class="tooltipped" data-position="bottom" data-tooltip="View the (majority of the) query executed on the server">
                                            <span>Show server's query?</span>
                                        </label>
                                    </div>                                    
                                    
                                    <!--Response Times?-->
                                    <div class="col m2">
                                        <label>
                                            <input type="checkbox" v-model="showColGroup_RespTimes" class="tooltipped" data-position="bottom" data-tooltip="View minutes holding, Rec to Ons, Dis to Ons">
                                            <span>Show Response Times?</span>
                                        </label> 
                                    </div>

                                    <!--Call Times?-->
                                    <div class="col m2">
                                        <label class="tooltipped" data-position="bottom" data-tooltip="View the timestamps for the call segments (Dis,Ons,Com)">
                                            <input type="checkbox" v-model="showColGroup_CallTimes" >
                                            <span>Show Call Times?</span>
                                        </label>    
                                    </div>   

                                    <!--Weather?-->
                                    <div class="col m2">
                                        <label>
                                            <input type="checkbox" v-model="showColGroup_Weather" class="tooltipped" data-position="bottom" data-tooltip="View the historic temperature and weather conditions (per the NWS)">
                                            <span>Show Weather?</span>
                                        </label>
                                    </div>

                                    <!--Unit Availability?-->
                                    <div class="col m2">
                                        <label>
                                            <input type="checkbox" v-model="showColGroup_UnitAvailability" class="tooltipped" data-position="bottom" data-tooltip="View the count of units that were on-duty, busy or available">
                                            <span>Show Unit Availability Counts?</span>
                                        </label> 
                                    </div>
                                    
                                </div>    
                                
                                <div class="row" v-if="showServerWhereClause==true">
                                    <small>                                
                                        Server Query:<br>
                                        <span style="font-family: 'Courier New', Courier, monospace">{{Where_AC}}</span><br>
                                    </small>
                                </div>

                                <!--Sticky Table Header-->
                                <div class="row results-box-thead" style="overflow-y:scroll; overflow-x:hidden;">
                                    <div class="col m12">
                                        <table class="results-table highlight" style="font-size: 0.9em;" v-if="calls.length > 0">
                                            <thead>

                                                <!--Column Group Headers-->
                                                <tr>
                                                    <th colspan="1"></th>
                                                    <th 
                                                        class="center-align" 
                                                        v-bind:class="{'grey darken-3 white-text':colGroup.name.length > 0}"
                                                        style="border:solid 1px #f5f5f5; padding:5px;" 
                                                        v-for="colGroup in columnHeadGroups" 
                                                        v-bind:colspan="colGroup.columns" 
                                                        v-if="showThisColumnGroup(colGroup.name)==true">
                                                        {{colGroup.name}}
                                                    </th>
                                                </tr>

                                                <!--Column Names-->
                                                <tr class="grey darken-4 white-text">
                                                    <th class="left-align" style="width:54px;border:solid 1px gray;">
                                                        Notes
                                                    </th>
                                                    <!--:class="{'hl': highlight(col.name),'center-align':col.schema.align=='center','left-align':col.schema.align=='left','right-align':col.schema.align=='right'}"-->
                                                    <th 
                                                        v-for="col in columns" 
                                                        v-bind:class="{'hl': highlight(col.name),'center-align':col.schema.align=='center','left-align':col.schema.align=='left','right-align':col.schema.align=='right','results-table-colGroup-start': col.isStart==true}"
                                                        v-bind:title="col.schema.tooltip"
                                                        @click="sortBy(col.name)"
                                                        v-if="showThisColumnGroup(col.schema.thGroup)==true"
                                                        v-bind:style="{'width': (parseInt(col.schema.width)+4) + 'px' || '54px'}"
                                                        style="border:solid 1px gray;"
                                                        >
                                                        {{col.schema.th}}
                                                    </th>
                                                </tr>
                                            </thead>
                                            <tbody></tbody>
                                        </table>
                                    </div>
                                </div>

                                <div class="row results-box-tbody" style="overflow-y:scroll; overflow-x:hidden;">
                                    <div class="col m12">
                                        <!--Results-->
                                        <table class="results-table highlight" style="font-size: 0.9em;" v-if="calls.length > 0">
                                            <thead></thead>
                                            <tbody class="white">
                                                <template v-for="call in filteredCalls">
                                                    <tr v-bind:class="{'bg-warning': callnumber == call.Call_Number && detailsAreOpen == true}">

                                                        <!--Detail-button-->
                                                        <td class="left-align" style="width:50px;">
                                                            <span 
                                                                v-on:click="callnumber = call.Call_Number ; detailsAreOpen = !detailsAreOpen ; getNotes(callnumber) ; getGlobalView(call.Date_Received)" 
                                                                style="color:blue; text-decoration: underline; cursor:pointer;">Details
                                                            </span>                                           
                                                        </td>
                                                        
                                                        <!--Data-->
                                                        <td v-for="col in columns"
                                                            :class="{'center-align':col.schema.align=='center','left-align':col.schema.align=='left','right-align':col.schema.align=='right','results-table-colGroup-start': col.isStart==true}"
                                                            v-html="(col.schema.type == 'integer' ? (parseInt(call[col.name]) == 0 ? '-' : call[col.name]) : call[col.name])"
                                                            v-if="showThisColumnGroup(col.schema.thGroup)==true"
                                                            v-bind:style="{'width': col.schema.width + 'px' || '50px'}"
                                                            >                                                                                            
                                                        </td>

                                                    </tr>
                                                            
                                                    <!--Unit Times-->
                                                        <tr v-if="callnumber == call.Call_Number && detailsAreOpen == true">
                                                            <td></td>
                                                            <td v-bind:colspan="Object.keys(schema).length-1">
                                                                <h4>Unit Times <small>(Ordered by On-Scene Time)</small></h4>
                                                            </td>
                                                        </tr>   
                                                        <tr v-if="callnumber == call.Call_Number && detailsAreOpen == true">
                                                            <td></td>                                                    
                                                            <td v-bind:colspan="Object.keys(schema).length-1">
                                                                <table style="background-color:whitesmoke; width:1300px;">
                                                                    <thead style="background-color:gainsboro;">
                                                                        <tr>
                                                                            <th style="text-align: center; width:100px;">Unit</th>
                                                                            <th style="text-align: center; width:100px;">Dept</th>
                                                                            <th style="text-align: center; width:100px;">Div</th>
                                                                            <th style="text-align: center; width:100px;">DIS</th>
                                                                            <th style="text-align: center; width:100px;">ENR</th>
                                                                            <th style="text-align: center; width:100px;">ONS</th>
                                                                            <th style="text-align: center; width:100px;">REM</th>
                                                                            <th style="text-align: center; width:100px;">COM</th>
                                                                        </tr>
                                                                    </thead>
                                                                    <tbody>
                                                                        <tr v-for="unit in JSON.parse(call.UnitTimes)">                                                                    
                                                                            <td style="text-align: center;">{{unit.Unit}}</td>
                                                                            <td style="text-align: center;">{{unit.Department}}</td>
                                                                            <td style="text-align: center;">{{unit.Division}}</td>
                                                                            <td style="text-align: center;">{{unit.DIS}}</td>
                                                                            <td style="text-align: center;">{{unit.ENR}}</td>
                                                                            <td style="text-align: center;">{{unit.ONS}}</td>
                                                                            <td style="text-align: center;">{{unit.REM}}</td>
                                                                            <td style="text-align: center;">{{unit.COM}}</td>
                                                                        </tr>
                                                                    </tbody>
                                                                </table>
                                                            </td>
                                                        </tr>

                                                    <!--Notes-->
                                                        <tr v-if="callnumber == call.Call_Number && detailsAreOpen == true"
                                                            v-bind:class="{'bg-secondary-light':callnumber == call.Call_Number && detailsAreOpen == true}">
                                                            <td></td>
                                                            <td v-bind:colspan="Object.keys(schema).length-1">
                                                                <h4>Call Notes</h4>
                                                            </td>
                                                        </tr>   
                                                        <tr v-if="callnumber == call.Call_Number && detailsAreOpen == true"                                                    
                                                            v-bind:class="{'bg-secondary-light':callnumber == call.Call_Number && detailsAreOpen == true}">
                                                            <td></td>                                                    
                                                            <td v-bind:colspan="Object.keys(schema).length-1">
                                                                <span v-if="notes.length == 0">Loading...</span>
                                                                <table v-if="notes.length > 0" style="background-color:whitesmoke; width:1300px;">
                                                                    <thead style="background-color:gainsboro;">
                                                                        <tr>
                                                                            <th></th>
                                                                            <th>Note</th>
                                                                        </tr>
                                                                    </thead>
                                                                    <tbody>
                                                                        <tr v-for="note in notes">
                                                                            <td class="text-primary">{{ (note.NoUnitsAvailNotes == 1 ? 'No Units Avail -->' : '' ) }}</td>
                                                                            <td v-bind:class="{'text-primary': note.NoUnitsAvailNotes == 1 }">{{note.Narrative}}</td>
                                                                        </tr>
                                                                    </tbody>
                                                                </table>
                                                            </td>
                                                        </tr>
                                                        
                                                    <!--Other Calls-->
                                                        <tr v-if="callnumber == call.Call_Number && detailsAreOpen == true"
                                                            v-bind:class="{'bg-secondary-light':callnumber == call.Call_Number && detailsAreOpen == true}">
                                                            <td></td>
                                                            <td v-bind:colspan="Object.keys(schema).length-1">
                                                                <h4>Other Calls Occuring When this Call was Received <small>(See map below)</small></h4>
                                                            </td>
                                                        </tr>   
                                                        <tr v-if="callnumber == call.Call_Number && detailsAreOpen == true"                                                     
                                                            v-bind:class="{'bg-secondary-light':callnumber == call.Call_Number && detailsAreOpen == true}">
                                                            <td></td>
                                                            <td v-bind:colspan="Object.keys(schema).length-1">
                                                                <span class="red white-text" style="padding:1em;" v-if="globalViewOtherCalls.length == 0">Loading historical data...</span>
                                                                <table v-if="globalViewOtherCalls.length > 0" style="background-color:whitesmoke; width:1300px;">
                                                                    <thead style="background-color:gainsboro;">
                                                                        <tr>
                                                                            <th>Call_Number</th>
                                                                            <th>Complaint</th>
                                                                            <th>Priority</th>
                                                                            <th>Date_Received</th>
                                                                            <th>Time_Complete</th>                                                                
                                                                            <th>Units</th>
                                                                        </tr>
                                                                    </thead>
                                                                    <tbody>
                                                                        <tr v-for="othercall in globalViewOtherCalls">
                                                                            <td>{{othercall.Call_Number}}</td>
                                                                            <td>{{othercall.Complaint}}</td>
                                                                            <td>{{othercall.Priority}}</td>
                                                                            <td>{{othercall.Date_Received}}</td>
                                                                            <td>{{othercall.Time_Complete}}</td>
                                                                            <td>{{othercall.Units}}</td>
                                                                        </tr>
                                                                    </tbody>
                                                                </table>
                                                            </td>
                                                        </tr>

                                                    <!--Map Image-->
                                                        <tr v-if="callnumber == call.Call_Number && detailsAreOpen == true"
                                                            v-bind:class="{'bg-secondary-light':callnumber == call.Call_Number && detailsAreOpen == true}">
                                                            <td></td>
                                                            <td v-bind:colspan="Object.keys(schema).length-1">
                                                                <h4>Map: <small>(Static map of calls and unit locations at the time this call was received)</small></h4>
                                                            </td>
                                                        </tr>   
                                                        <tr v-if="callnumber == call.Call_Number && detailsAreOpen == true"                                                    
                                                            v-bind:class="{'bg-secondary-light':callnumber == call.Call_Number && detailsAreOpen == true}">
                                                            <td></td>
                                                            <td v-bind:colspan="Object.keys(schema).length-1">
                                                                <span class="red white-text" style="padding:1em;" v-if="globalViewMapUrl.length == 0">Loading historical data and creating map image...</span>
                                                                <img v-if="globalViewMapUrl.length > 0" v-bind:src="globalViewMapUrl" style="border:solid 1px gray;" />
                                                            </td>
                                                        </tr>
                                                </template>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div> <!--Table .row-->
                            
                        <!--Map-->
                        <div class="row map-row" v-show="resultsMode == 'map' && calls.length > 0" style="border:solid 1px gray;">

                            <div class="col-md-12">
                            
                                <!--Table or Map Buttons-->
                                <div class="row" v-if="calls.length > 1">
                                    <div class="col m12 center-align">
                                            <a class="waves-effect waves-light btn-flat" v-on:click="resultsMode = 'table'" v-bind:class="{'blue-text':resultsMode == 'table'}">
                                                <i class="material-icons left">menu</i>
                                                Table
                                            </a>
                                            <a class="waves-effect waves-light btn-flat" v-on:click="resultsMode = 'map'" v-bind:class="{'blue-text':resultsMode == 'map'}">
                                                <i class="material-icons left">location_on</i>
                                                Map
                                            </a>                              
                                    </div>                                    
                                </div>

                                <!--Map-->
                                <div class="row">

                                    <!--Layer Control-->
                                    <div style="position:absolute; top: 830px; right:75px; height: 75px; width:155px; background:whitesmoke; z-index:999;padding:0.8em;">
                                        <div v-for="mapService in mapServices">
                                            <div class="custom-control custom-checkbox">
                                                <label>
                                                    <input type="checkbox" v-bind:id="'customCheckMapService'+mapService.id" disabled="true">
                                                    <span>{{splitCamelCase(mapService.label)}}</span>
                                                </label>                                                
                                            </div>
                                        </div>
                                    </div>

                                    <!--Map Object-->
                                    <div id="viewDiv"></div>

                                </div>
                            </div> <!--end map row 1-->
                        </div> <!--end map row 2-->

                    </div> <!--end col-->
                </div> <!--end row-->
                
            </div> <!--end results column-->   
   
        </div> <!--end main-body row-->
        
            <!-- Modal - url -->
            <div id="modal1" class="modal">
                <div class="modal-content">
                    <h3>Direct Url to these Settings</h3>
                    <p>You can send this url to someone in an email, or to bookmark it, paste into a new tab, the bookmark the site via your browser.</p>
                    <p><input type="text" style="width:100%;background:transparent;border:none;font-size:0.8em;" v-bind:value="setUrlParams()"/></p>
                </div>
                <div class="modal-footer">
                    <a href="#!" class="modal-close waves-effect waves-green btn-flat">Close</a>
                </div>
            </div>  <!--end modal--> 
        </div>

    </div> <!--end app-->

    <!--================================================================-->
    <script>
        var app = new Vue({
            el: "#app",
            data: {
                calls: [],
                noResultsFound: false,
                serverErrorOccurred: false,
                callnumber: '',
                notes: [],
                detailsAreOpen: false,
                sortOrder: 1,
                sortKey: '',
                showUnits: false,
                isEmployee: 0,
                username: '',
                showLink: false,
                showServerWhereClause: false,
                showParams: true,
                showColGroup_CallTimes: false,
                showColGroup_RespTimes: false,
                showColGroup_Weather: false,
                showColGroup_UnitAvailability: false,
                ajaxInProgress: false,                
                exampleMessage: "",
                resultsMode: "table",
                mapLayerIsLoading: false,
                oppositeParameterName: '',
                oppositeCalls: [],
                globalViewOtherCalls: [],
                globalViewVehicles: [],
                globalViewMapUrl: '',
                activeSection: '',
                Where_AC: '',
                sections: {},
                parameters: {},
                schema: {}
            }, 
            created: function(){   
                var _this = this

                //From settings.js file                
                Object.keys(__SETTINGS__).forEach(function(_r){
                    Vue.set(_this,_r, __SETTINGS__[_r]) //use Vue.set to ensure reactivity is added
                })
                
            },    
            mounted: function(){
                this.init()
            },  
            watch: {
                showParams: function(_newValue,_oldValue){
                    if (_newValue == false){
                        $(".parameters-column").fadeOut('slow')
                    }
                    if (_newValue == true){
                        $(".parameters-column").fadeIn('slow')
                    }
                }
            },
            methods: {
                init: function(){
                    var _this = this
                    
                    _this.getDropdownListValues()                    
                    _this.setParamsFromUrl() 
                    _this.materializeComponents()                                 
                   
                },
                materializeComponents: function(){
                    $('.collapsible').collapsible();                    
                    $('.collapsible').on('change',function(event){ window.scrollTo(0,0) }); //Prevent collapsible from scrolling the window down                    
                    $('select').formSelect();  //_this.getDropdownListValues() adds <option> elements when finished
                    $('.modal').modal();
                    $('.tooltipped').tooltip();
                },                
                cleanParamsForServer: function(){
                    var _this = this
                    var _params = {}
                    
                    //csv

                    Object.keys(_this.parameters).forEach(function(p){
                        var pname = p
                        var _obj = _this.parameters[pname]

                        if (_obj.type == "csv" && Array.isArray(_this.parameters[pname].value) == false){
                            if (_this.parameters[pname].value !== ''){_params[pname] = JSON.stringify(_this.parameters[pname].value.split(",").map(function(a){return {"value": a}}))}
                        }

                        if (_obj.type == "text" && Array.isArray(_this.parameters[pname].value) == false){
                            if (_this.parameters[pname].value.length > 0){_params[pname] = _this.parameters[pname].value}
                        }

                        if (_obj.type == "multiselect" && Array.isArray(_this.parameters[pname].value) == true){
                            if (_this.parameters[pname].value.length > 0){

                                var _mapped = _this.parameters[pname].value.map(function(_value){
                                    return {"value": _value}
                                })
                                _params[pname] = JSON.stringify(_mapped)
                            }
                        }

                        if (_obj.type == "boolean" && Array.isArray(_this.parameters[pname].value) == false){
                            if (_this.parameters[pname].value == true){_params[pname] = 1}
                        }

                        if (_obj.type == "datetime" && Array.isArray(_this.parameters[pname].value) == false){
                            if (_this.parameters[pname].value !== ''){_params[pname] = _this.parameters[pname].value}
                        }

                        if (_obj.type == "time" && Array.isArray(_this.parameters[pname].value) == false){
                            if (_this.parameters[pname].value.length > 0){_params[pname] = _this.parameters[pname].value}
                        }

                        if (_obj.type == "integer" && Array.isArray(_this.parameters[pname].value) == false){
                            if (_this.parameters[pname].value !== ''){_params[pname] = parseInt(_this.parameters[pname].value)}
                        }
                    })

                    return _params
                },
                runReport: function(){
                    var _this = this
                    var _params = _this.cleanParamsForServer()

                    var _oppositeParametersToReturn = Object.keys(_params).filter(function(_p){
                        return _this.parameters[_p].hasOwnProperty("oppositeParameter") && _this.parameters[_p].oppositeParameter.include == true && _params[_p].length > 0
                    })
                    
                    //GetCalls()
                    if (_oppositeParametersToReturn.length > 0){
                        //Main call
                            _this.getCalls()

                        //Secondary call
                            var _paramName = _oppositeParametersToReturn[0]
                            var _oppositeParamName = _this.parameters[_paramName].oppositeParameter.name                        
                            _this.oppositeParameterName = _oppositeParamName
                            
                            //Swap values
                            _params[_oppositeParamName] = _params[_paramName]
                            delete _params[_paramName]
                            console.log(_params)

                            //Get opposite calls
                            _this.getCallsOpposite(_params)

                    }else{
                        _this.getCalls()
                    }
                },              
                getCalls: function(){
                    var _this = this
                    
                    //Reset _this.calls
                    _this.calls = []

                    var _params = _this.cleanParamsForServer()
                    _params.webservice = "CallsAnalysisGet"
                    //_params.auth_token = localStorage.colAuthToken

                    _this.ajaxInProgress = true
                    _this.serverErrorOccurred = false
                    _this.noResultsFound = false

                    axios.post('https://query.cityoflewisville.com/v2', _params)
                    .then(function(_results){ 

                        if (_results.data[0][0].hasOwnProperty("Id")){ 
                            console.log("Calls returned")

                            _this.calls = _results.data[0]
                            _this.Where_AC = _this.calls[0]._Where_AC
                            
                            _this.noResultsFound = false
                            _this.ajaxInProgress = false
                            _this.serverErrorOccurred = false
                            
                        }else{
                            _this.Where_AC = _results.data[0][0]._Where_AC

                            _this.noResultsFound = true
                            _this.ajaxInProgress = false
                            _this.serverErrorOccurred = false
                        }
                    })
                    .catch(function(error){ 
                        _this.ajaxInProgress = false
                        _this.serverErrorOccurred = true
                        _this.noResultsFound = true
                        console.error(error)
                    })
                },
                getCallsOpposite: function(_params){
                    var _this = this
                    
                    //Reset _this.oppositeCalls
                    _this.oppositeCalls = []
                    
                    _params.webservice = "CallsAnalysisGet"
                    //_params.auth_token = localStorage.colAuthToken

                    axios.post('https://query.cityoflewisville.com/v2', _params)
                    .then(function(_results){ 

                        if (_results.data[0][0].hasOwnProperty("Id")){ 

                            console.log("Opposite Calls returned")
                            _this.oppositeCalls = _results.data[0]

                        }
                    })
                    .catch(function(error){
                        console.error(error)
                    })
                },
                getDropdownListValues: function(){
                    var _this = this
                    axios.post('https://query.cityoflewisville.com/v2', {
                        webservice: "CallsAnalysisDropdownLists",
                        auth_token: localStorage.colAuthToken
                    })
                    .then(function(_results){  
                        if (typeof _results.data[0][0] != 'undefined'){

                            var _multiselects = Object.keys(_this.parameters).filter(function(_p){
                                return _this.parameters[_p].type == "multiselect"
                            })

                            //Materialize <select> override
                            $('.materialSelect').on('contentChanged', function() {
                                $(this).formSelect();
                            });

                            _multiselects.forEach(function(_p){
                                var _thisParamsCategory = _results.data[0].filter(function(_d){
                                    return _d.cat == _this.parameters[_p].dropdownList
                                })
                                _this.parameters[_p].options = _thisParamsCategory.map(function(c){
                                    return {code: c.code, description: c.description}                                        
                                })
                                
                                //Materialize <select> override
                                _thisParamsCategory.forEach(function(c){                                                   
                                    var $newOpt = $("<option>").attr("value",c.code).text(c.code + (c.description.length > 0 ? " | " + c.description : ""))
                                    $("#ms_"+ _p).append($newOpt);                                    
                                })                                
                                $("#ms_"+ _p).trigger("contentChanged")
                            })
                        }
                    })
                    .catch(function(error){ 
                        console.error("getDropdownListValues")
                        console.error(error)
                    })
                },
                getNotes: function(_callnumber){
                    var _this = this
                    axios.post('https://query.cityoflewisville.com/v2', {
                        webservice: "CallsAnalysisNotes",
                        auth_token: localStorage.colAuthToken,
                        callnumber: _callnumber
                    })
                    .then(function(_results){  
                        if (typeof _results.data[0][0] != 'undefined'){
                            _this.notes = _results.data[0]
                        }
                    })
                    .catch(function(error){ 
                        console.error(error)
                    })
                },
                getGlobalView: function(_datetime){
                    var _this = this

                    //Reset parameters
                        _this.globalViewOtherCalls = []
                        _this.globalViewVehicles = []
                        _this.globalViewMapUrl = ''

                    //Get data
                        axios.post('https://query.cityoflewisville.com/v2', {
                            webservice: "CallsAnalysisGlobalView",
                            auth_token: localStorage.colAuthToken,
                            date_received: _datetime
                        })
                        .then(function(_results){
                            _this.globalViewOtherCalls = _results.data.OtherCalls
                            _this.globalViewVehicles = _results.data.Vehicles
                            _this.globalViewMapUrl = _results.data.MapUrl[0].Url
                        })
                        .catch(function(error){ 
                            console.error(error)
                        })
                },
                getUrlParam: function(_name){
                    return decodeURIComponent((new RegExp('[?|&|]' + _name + '=' + '([^&;]+?)(&|#|;|$)').exec(location.search)||[,""])[1].replace(/\+/g, '%20'))||null;
                },
                setParamsFromUrl: function(){
                    var _this = this
                    var _params = []

                    Object.keys(_this.parameters).forEach(function(k){
                        var _paramValue = _this.getUrlParam(k)
                        
                        if (_paramValue != null){                              
                            if (_this.parameters[k].type == "multiselect"){
                                try{_this.parameters[k].value = JSON.parse(_paramValue)}catch(e){}
                            }else if(_paramValue.toLowerCase() == "true"){
                                _this.parameters[k].value = true
                            }else if(_paramValue.toLowerCase() == "false"){
                                _this.parameters[k].value = true
                            }else{
                                _this.parameters[k].value = _paramValue
                            }
                        }
                    })
                },
                setUrlParams: function(){
                    var _this = this                    
                    var _queryString = []
                    var _params = []
                    var _queryString = []

                    Object.keys(_this.parameters).forEach(function(pname){
                        if (_this.parameters[pname].type == "multiselect"){
                            if (_this.parameters[pname].value.length > 0){
                                _queryString.push(pname + "=" + encodeURIComponent(JSON.stringify(_this.parameters[pname].value)))
                            }
                        }
                        if (_this.parameters[pname].type != "multiselect") { 
                            if (_this.parameters[pname].value != ''){
                                _queryString.push(pname + '=' + encodeURIComponent(_this.parameters[pname].value))
                            }
                        }
                    })

                    return window.location.protocol + '//' + window.location.host + window.location.pathname + "?" + _queryString.join("&")
                },
                resetCsv(_param){
                    var _this = this
                    console.log("resetCsv")
                    console.log(_this.parameters[_param].value)
                    _this.parameters[_param].value = []
                    console.log(_this.parameters[_param].value)
                },
                resetMultipleChoice(_param){
                    var _this = this
                    _this.parameters[_param].value = []
                },
                resetFromTo(_paramLo,_paramHi){
                    var _this = this
                    _this.parameters[_paramLo].value = []
                    _this.parameters[_paramHi].value = []
                },
                resetSingle(_param){
                    var _this = this
                    _this.parameters[_param].value = []
                },
                resetDateParams(_thisControl,_val){
                    var _this = this
                    if (_val == true){
                        _this.parameters.AC_DateReceivedLo.oldValue = _this.parameters.AC_DateReceivedLo.value
                        _this.parameters.AC_DateReceivedHi.oldValue = _this.parameters.AC_DateReceivedHi.value

                        _this.parameters.AC_DateReceivedLo.value = ''
                        _this.parameters.AC_DateReceivedHi.value = ''

                        Object.keys(_this.parameters).forEach(function(k){
                            if (k.substring(0,19)=="AC_DateReceivedPast" && k != _thisControl){
                                _this.parameters[k].value = false
                            }
                        })
                        
                    }else{
                        _this.parameters.AC_DateReceivedLo.value = _this.parameters.AC_DateReceivedLo.oldValue
                        _this.parameters.AC_DateReceivedHi.value = _this.parameters.AC_DateReceivedHi.oldValue
                    }                    
                },
                average: function(_fieldName,_decimalPlaces){
                    var _this = this
                    var _final = 0

                    
                    var _values = _this.calls.map(function(c){
                        return c[_fieldName]
                    })

                    var _average = function(_array){
                        return _array.reduce(function (p, c) {
                            return p + c;
                        }) / _array.length;
                    }

                    _final = _average(_values).toFixed(_decimalPlaces || 2)
                    
                    return (isNaN(_final) ? '-' : _final)
                },
                sortBy: function (key) {
                    var _this = this                    
                    _this.sortKey = key
                    _this.sortOrder = _this.sortOrder * -1                               
                },
                highlight: function(_fieldName){
                    var _this = this
                    var _score = 0
                    var _paramNamesSentToServer = Object.keys(_this.cleanParamsForServer()).map(function(k){
                        return k
                    })

                    if (_this.schema[_fieldName] && _this.schema[_fieldName].hasOwnProperty("parameters")){
                        _this.schema[_fieldName].parameters.forEach(function(p){
                            if (_paramNamesSentToServer.indexOf(p) > -1){
                                _score += 1
                            }
                        })
                    }

                    return (_score > 0 ? true : false)
                },
                parametersArrayFiltered: function(_section){
                    var _this = this
                    return _this.parametersArray.filter(function(f){
                        return f.settings.section == _section
                    })
                },
                right: function(_string,_numberOfCharacters){
                    return _string.substr(_string.length - _numberOfCharacters)
                },
                resetAllParameters: function(){
                    var _this = this
                    Object.keys(_this.parameters).forEach(function(p){
                        if (_this.parameters[p].type == "multiselect"){
                            _this.parameters[p].value.length = 0
                        }else{
                            _this.parameters[p].value = ''
                        }
                    })

                    //Set date to be "past 1 month"
                    _this.parameters.AC_DateReceivedPast1Months.value = true
                    _this.calls = []
                },
                splitCamelCase: function(_string){
                    return _string.replace(/([A-Z])/g, ' $1')
                },
                countActive: function(_section){
                    var _this = this
                    var _params = Object.keys(_this.cleanParamsForServer()).filter(function(_p){
                        return _this.parameters[_p].section == _section
                    })
                    return _params.length
                },
                showThisColumnGroup: function(_columnGroupName){
                    var _this = this
                    var _groups = [""]
                    
                    if (_this.showColGroup_CallTimes == true){_groups.push("Call Times")}
                    if (_this.showColGroup_RespTimes == true){_groups.push("Resp Time")}
                    if (_this.showColGroup_Weather == true){_groups.push("Weather")}
                    if (_this.showColGroup_UnitAvailability == true){_groups.push("Patrol"); _groups.push("Traffic")}

                    if (_groups.indexOf(_columnGroupName) > 0 || _columnGroupName.length == 0){
                        return true
                    }else{
                        return false
                    }
                },
                example1: function(){
                    var _this = this
                    _this.resetAllParameters()
                    _this.showParams = false

                    _this.parameters.AC_DateReceivedPast1Months.value = true
                    _this.parameters.AC_DateReceivedPast1Years.value = false
                    _this.parameters.AC_Disposition.value = ['FX','AX']
                   
                    _this.exampleMessage = "Parameters are set. Running query in 1 second"
                    _this.runReport()            
                },
                example2: function(){
                    var _this = this
                    _this.resetAllParameters()
                    _this.showParams = false

                    _this.parameters.AC_DateReceivedPast1Months.value = false
                    _this.parameters.AC_DateReceivedPast1Years.value = true
                    _this.parameters.AC_PriorityLo.value = 1
                    _this.parameters.AC_PriorityHi.value = 1
                    _this.parameters.AC_MinutesHoldingLo.value = 5
                    _this.parameters.AC_MinutesHoldingHi.value = 1000

                    _this.exampleMessage = "Parameters are set. Running query in 1 second"
                    _this.runReport()   
                }
            },
            computed:{
                filteredCalls: function(){
                    var _this = this
                    var _sortKey = _this.sortKey
                    var _order = _this.sortOrder || 1

                    var _calls = _this.calls

                    _calls = _calls.slice().sort(function(a,b){
                        if (_this.schema[_sortKey]){
                            switch (_this.schema[_sortKey].type) {
                                case "integer":
                                    a = parseInt(a[_sortKey])
                                    b = parseInt(b[_sortKey])
                                    break;
                                case "datetime":
                                    a = new Date(a[_sortKey])
                                    b = new Date(b[_sortKey])
                                    break;
                                default:
                                    a = a[_sortKey]
                                    b = b[_sortKey]
                            }
                        }
                        return (a === b ? 0 : a > b ? 1 : -1) * _order
                    })

                    return _calls
                },          
                paramsPretty: function(){
                    var _this = this
                    var _str = ''
                    var _done = []
                    
                    //Dates
                        var _dates = Object.keys(_this.cleanParamsForServer()).filter(function(p){
                            return p.substr(0,10) == 'AC_DateRec'
                        }).forEach(function(p){
                            if (_this.parameters[p].value == true) _str = "[Date Received] is within the " + _this.parameters[p].label1 + " ; "      
                            _done.push(p)                 
                        })
                    
                    //Multiselect
                        var _multiselect = Object.keys(_this.cleanParamsForServer()).filter(function(p){
                            return _done.indexOf(p) < 0
                        })
                        .filter(function(p){
                            return _this.parameters[p].type == "multiselect"
                        })
                        _multiselect.forEach(function(p){
                            var pname = p
                            var _obj = _this.parameters[pname]
                            _str += "[" + p.replace("AC_","") + "] IN(" + _this.parameters[p].value.join(",") + ") ; "
                            _done.push(p)
                        })

                    //Lo / Hi
                        var _loHi = Object.keys(_this.cleanParamsForServer()).filter(function(p){
                            return _done.indexOf(p) < 0
                        })
                        .filter(function(p){
                            return _this.parameters[p].loHi == true && p.substr(p.length-2) != 'Hi'
                        }) 
                        .forEach(function(p){
                            _str += "[" + p.replace("AC_","").replace("Lo","") + "] BETWEEN " + _this.parameters[p].value + " AND " + _this.parameters[p.replace("Lo","Hi")].value + " ; "
                        })

                        Object.keys(_this.cleanParamsForServer()).filter(function(p){
                            return _this.parameters[p].loHi == true
                        }).forEach(function(p){
                            _done.push(p)
                        })  

                    //Others
                        var _others = Object.keys(_this.cleanParamsForServer()).filter(function(p){
                            return _done.indexOf(p) < 0
                        })
                        .forEach(function(p){
                            _str += "[" + p.replace("AC_","") + "] = " + _this.parameters[p].value + " ; "
                        })
                        
                    return _str
                },
                columns: function(){
                    var _this = this

                    var _cols = Object.keys(_this.schema)
                    .filter(function(k){
                        return _this.schema[k].visible != false
                    })
                    .map(function(k){
                        return {
                            name: k, 
                            schema: _this.schema[k]
                        }
                    })

                    _cols.forEach(function(_c,i){
                        if ( i > 0 ){
                            if (_c.schema.thGroup != _cols[i-1].schema.thGroup){
                                _cols[i].isStart = true
                            }else{
                                _cols[i].isStart = false
                            }
                        }
                    })
                    return _cols
                },
                columnHeadGroups: function(){
                    var _this = this

                    var _groups = Object.keys(_this.schema)
                    .filter(function(k){
                        return [k] != 'Id'
                    })
                    .map(function(k){
                        return {name: _this.schema[k].thGroup,columns: 1}
                    })
                    
                    var _groupsRolledUp = _groups.reduce(function(res,obj){
                        if (!(obj.name in res))
                            res.__array.push(res[obj.name] = obj);
                        else {
                            res[obj.name].columns += obj.columns;
                        }
                        return res;
                    }, {__array:[]}).__array
                    
                    return _groupsRolledUp
                },
                paramSections: function(){
                    var _this = this
                    var _sections = []
                    Object.keys(_this.sections).forEach(function(k){
                        _sections.push( {name: k, title1: _this.sections[k].title1,title2: _this.sections[k].title2} )
                    })
                    return _sections
                },
                parametersArray: function(){
                    //EXCLUDES loHi "Hi" parameters
                    var _this = this
                    var _params = []
                    Object.keys(_this.parameters)
                    .forEach(function(k){
                        _params.push( {name: k, settings: _this.parameters[k]} )
                    })
                    return _params.filter(function(k){
                        return k.name.substr(k.name.length-2) != 'Hi'
                    })
                },
                points: function(){
                    var _this = this                    
                    return _this.calls
                },
                mapServices: function(){
                    var _this = this

                    //Array of parameter-names where the parameter has the property "mapService"
                        var _array = Object.keys(_this.parameters)
                            .filter(function(_k){
                                return _this.parameters[_k].hasOwnProperty("mapService") && _this.parameters[_k].mapService.length > 0
                            })
                            .map(function(_p){
                                return {
                                    id: _p,
                                    label: _p.replace("AC_",""),
                                    url: _this.parameters[_p].mapService
                                }
                            })

                    //Set mapServiceActive (one-way --> reactivity)
                        _array.forEach(function(_a){
                            var _id = _a.id
                            var _param = _this.parameters[_id]
                            
                            if (_param.type == "multiselect"){
                                _this.parameters[_id].mapServiceActive = (_param.value.length > 0 ? true : false)
                            }else if (_param.type == "boolean"){
                                _this.parameters[_id].mapServiceActive = _param.value
                            }else{
                                _this.parameters[_id].mapServiceActive = (_param.value.length > 0 ? true : false)
                            }
                        })

                    return _array
                },
                oppositeCallsWhereExplanation: function(){
                    var _this = this
                    
                    var _oppositeParamName = _this.oppositeParameterName
                    var _originalParamObj = _this.parameters[_oppositeParamName]
                    var _paramValuesRaw = JSON.parse(_this.cleanParamsForServer()[_originalParamObj.oppositeParameter.name])
                    
                    var _paramValues = _paramValuesRaw.map(function(_p){
                        return _p.value
                    }).join(",")
                    
                    return "Opposite Parameter's Query: [" + _oppositeParamName.replace("AC_","") + "] IN(" + _paramValues + ")"
                },
                oppositeCallsPercent: function(){
                    var _this = this
                    var _value = (_this.oppositeCalls.length > 0 ? (_this.calls.length / (_this.calls.length + _this.oppositeCalls.length)) : 0)*100
                    return Math.round(_value,1) + "%"
                }
            }
        })
    </script>

    <script>        
        var _map = require([
            "esri/Map",
            "esri/views/MapView",     
            "esri/layers/MapImageLayer",
            "esri/layers/FeatureLayer",
            "esri/geometry/Point"
        ], function(
            Map, MapView, MapImageLayer, FeatureLayer, Point
        ) {

            //-------------------------------------------------------
            //Master Map object
            //-------------------------------------------------------            
                var _cityLimitsLayer = new MapImageLayer({
                    id: "citylimits",
                    url: "https://adaptergis.cityoflewisville.com/arcgis/rest/services/GEM/GEM_LewisvilleCityLimits_Line/MapServer",
                    title: "City Limits"
                })

                var map = new Map({
                    basemap: "hybrid",
                    layers: [_cityLimitsLayer]
                });

                var view = new MapView({               
                    container: "viewDiv",
                    map: map,
                    center: [-96.9571323598633,33.04874516100256],
                    zoom: 13
                });

                view.watch("updating",function(_event){   
                    app.mapLayerIsLoading = _event
                })

            //-------------------------------------------------------
            //Master Data object
            //-------------------------------------------------------
                var Data = {
                    points: [],
                    layers: {},
                    fields: []
                } 

            //-------------------------------------------------------
            //Renderers
            //https://developers.arcgis.com/javascript/latest/api-reference/esri-renderers-Renderer.html
            //-------------------------------------------------------
            var _rendererHeatmap = {
                type: "heatmap",
                colorStops: [
                    { color: "rgba(63, 40, 102, 0)", ratio: 0 },
                    { color: "#472b77", ratio: 0.083 },
                    { color: "#4e2d87", ratio: 0.166 },
                    { color: "#563098", ratio: 0.249 },
                    { color: "#5d32a8", ratio: 0.332 },
                    { color: "#6735be", ratio: 0.415 },
                    { color: "#7139d4", ratio: 0.498 },
                    { color: "#7b3ce9", ratio: 0.581 },
                    { color: "#853fff", ratio: 0.664 },
                    { color: "#a46fbf", ratio: 0.747 },
                    { color: "#c29f80", ratio: 0.830 },
                    { color: "#e0cf40", ratio: 0.913 },
                    { color: "#ffff00", ratio: 1 }
                ],
                maxPixelIntensity: 25,
                minPixelIntensity: 0
            };

            var _rendererCircles = {
                type: "simple",
                symbol: {
                    type: "simple-marker",
                    style: "circle",
                    size: 20,
                    color: [211, 255, 0, 0],
                    outline: {
                        width: 1,
                        color: "#FF0055",
                        style: "solid"
                    }
                },
                visualVariables: [{
                    type: "size",
                    field: "LocationCount",    //LocationCount
                    valueUnit: "unknown",
                    minDataValue: 1,
                    maxDataValue: 1,                   
                    minSize: {
                        type: "size",
                        valueExpression: "$view.scale",
                        stops: [
                            { value: 1128, size: 12 },
                            { value: 36111, size: 12 },
                            { value: 9244649, size: 6 },
                            { value: 73957191, size: 4 },
                            { value: 591657528, size: 2 }
                        ]
                    },                   
                    maxSize: {
                        type: "size",
                        valueExpression: "$view.scale",
                        stops: [
                            { value: 1128, size: 80 },
                            { value: 36111, size: 60 },
                            { value: 9244649, size: 50 },
                            { value: 73957191, size: 50 },
                            { value: 591657528, size: 25 }
                        ]
                    }
                }]
            };
            
            //-------------------------------------------------------
            //Create an Array of Graphics from an Array of Points
            //-------------------------------------------------------
                function createGraphics(_calls) {

                    var _graphics = _calls.map(function(_call,i){
                        
                        var _attributes = {}

                        Data.fields.forEach(function(_f){
                            _attributes[_f.name] = _call[_f.dbName]
                        })

                        return {
                            geometry: new Point({
                                x: _call.lng,
                                y: _call.lat
                            }),
                            attributes:_attributes,
                            symbol: {
                                type: "simple-marker",
                                color: [226, 119, 40],
                                outline: { 
                                    color: [255, 255, 255],
                                    width: 2
                                }
                            }
                        }
                    })

                    return _graphics
                }

            //-------------------------------------------------------
            //Create a Feature Layer from an array of Graphics
            //-------------------------------------------------------
                function createFeatureLayer(_graphics,_renderer) {
                
                    //Set maxDataValue (max LocationCount)
                        _rendererCircles.visualVariables[0].maxDataValue = Math.max.apply(null,Data.points.map(function(p){
                            return p.LocationCount
                        }))

                    //Map fieds to popup template
                        var _popupTemplate = {
                            title:"{complaint}",
                            content:[{
                                type:"fields"
                            }]
                        } 
                        _popupTemplate.content[0].fieldInfos = Data.fields.map(function(_f){
                            return {
                                fieldName:_f.name,
                                label:_f.alias,
                                visible:true
                            }
                        })

                    //Feature layer
                        _layer = new FeatureLayer({
                            source: _graphics,
                            fields: Data.fields,
                            objectIdField: "ObjectID", // This must be defined when creating a layer from Graphics
                            renderer: _renderer,
                            popupTemplate: _popupTemplate,

                            labelingInfo: [{                        
                                labelPlacement: "above-center", // When using callouts on labels, "above-center" is the only allowed position
                                labelExpressionInfo: {
                                    value: "{LocationCount}"
                                },
                                symbol: {
                                    type: "text", // autocasts as new TextSymbol()
                                    color: "red",
                                    haloColor: "white",
                                    haloSize: "3px",                                    
                                    verticalOffset: {
                                        screenLength: 150,
                                        maxWorldLength: 2000,
                                        minWorldLength: 30
                                    },
                                    callout: {
                                        type: "line", // autocasts as new LineCallout3D()
                                        size: 0.5,
                                        color: [0, 0, 0],
                                        border: {
                                            color: [255, 255, 255, 0.7]
                                        }
                                    }
                                }
                            }]
                        });

                    return _layer;
                }

            //-------------------------------------------------------
            //Poll Vue object (2 secs) for new calls (poor-man's reactivity)
            //-------------------------------------------------------
                setInterval(function(){

                    if (Data.points.length != app.points.length){
                        
                        //Local copy of points is set to value in Vue
                            Data.points = app.points.map(function(_p){
                                return _p
                            })

                        //Promise start-point
                            function getPoints() {
                                var _results = new Promise(function(resolve, reject) {
                                    resolve(Data.points)    // Data.points                
                                })
                                return _results
                            }

                        //Create Data.fields from app.schema
                            Data.fields = Object.keys(app.schema)
                            .filter(function(_k){
                                return _k != 'Id'
                            })
                            .map(function(_k){
                                return {
                                    name: _k,
                                    alias: app.schema[_k].th,
                                    type: (app.schema[_k].type == "integer" ? "double" : (app.schema[_k].type == "decimal" ? "double" : "string")),
                                    dbName: _k
                                }
                            })
                            
                            Data.fields.push({
                                name: 'Units',
                                alias: 'Units',
                                type: "string",
                                dbName: 'Units'
                            })
                            //console.log(Data.fields)
                        
                        //Remove existing layers
                            Object.keys(Data.layers).forEach(function(_lyr){
                                map.layers.remove(Data.layers[_lyr])
                            })

                        //Heatmap
                            getPoints()
                                .then(createGraphics)
                                .then(function(_graphics){
                                    return createFeatureLayer(_graphics,_rendererHeatmap)
                                })
                                .then(function(_layer){
                                    _layer.popupEnabled = false     //disable popups on 1 of the 2 layers to prevent duplicate records
                                    Data.layers.layerHeatmap = _layer
                                    map.add(_layer)
                                })

                        //Circles                        
                            getPoints()
                                .then(createGraphics)
                                .then(function(_graphics){
                                    return createFeatureLayer(_graphics,_rendererCircles)
                                })
                                .then(function(_layer){
                                    Data.layers.layerCircles = _layer
                                    map.add(_layer)
                                })

                        //Are there any new web services (layers) to turn on?
                            Object.keys(app.cleanParamsForServer()).forEach(function(p){
                                if( app.parameters[p].mapService ){
                                    var _layer = new MapImageLayer({
                                        id: "xyz",
                                        url: app.parameters[p].mapService,
                                        opacity: 0.6
                                    })

                                    //Keep this layer-object in our own array for future reference
                                    Data.layers["mapService_" + p] = _layer

                                    //Add this layer-object to the map
                                    map.add(_layer)
                                    
                                    //Checkbox for layer
                                    var _$checkbox = document.getElementById('customCheckMapService'+p)
                                    
                                        _$checkbox.checked = true
                                        _$checkbox.disabled = false

                                        //Change event
                                        _$checkbox.addEventListener("change",function(_event){
                                            Data.layers["mapService_" + p].visible = _event.target.checked                                        
                                        })
                                }                        
                            })

                    } //end if
                },2000)
        });
        
    </script>
    
</body>
</html>